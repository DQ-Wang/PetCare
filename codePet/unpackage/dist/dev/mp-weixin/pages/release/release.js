"use strict";const e=require("../../common/vendor.js"),_=require("../../common/assets.js"),N=require("../../js_sdk/qqmap-wx-jssdk1.2/qqmap-wx-jssdk.js");Array||e.resolveComponent("uni-file-picker")();const O=()=>"../../uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.js";Math||O();const P={__name:"release",setup(T){const x=e.nr.database(),h=e.ref(null),d=e.ref([]),f=e.ref(""),g=e.ref(""),o=e.ref([]),r=e.ref(""),m=e.ref([]),w=e.ref(null),l=e.ref(null),u=e.ref([]),p=e.ref(!1),y=e.computed(()=>u.value.slice(0,4));e.onMounted(()=>{C(),$(),e.index.$on("locationSelected",t=>{e.index.__f__("log","at pages/release/release.vue:107","收到位置选择事件",t),S(t)})});const $=()=>{w.value=new N.QQMapWX({key:"NJDBZ-3U5KT-VVCXD-VKCO5-M6M33-6WFDR"}),e.wx$1.getSetting({success:t=>{t.authSetting["scope.userLocation"]?v():e.wx$1.authorize({scope:"scope.userLocation",success:()=>{e.index.__f__("log","at pages/release/release.vue:127","位置授权成功"),v()},fail:i=>{e.index.__f__("log","at pages/release/release.vue:131","位置授权失败",i),L()}})},fail:t=>{e.index.__f__("error","at pages/release/release.vue:138","获取设置失败",t),L()}})},L=()=>{e.wx$1.showModal({title:"位置权限请求",content:"需要您的位置信息来查找附近地点",success(t){t.confirm&&e.wx$1.openSetting({success(i){i.authSetting["scope.userLocation"]?v():e.wx$1.showToast({title:"权限请求被拒绝",icon:"none"})}})}})},v=()=>{e.wx$1.getLocation({type:"gcj02",success:t=>{e.index.__f__("log","at pages/release/release.vue:170","获取位置成功",t),l.value={latitude:t.latitude,longitude:t.longitude},k()},fail:t=>{e.index.__f__("error","at pages/release/release.vue:178","获取位置失败",t),e.index.showModal({title:"定位失败",content:"请检查位置权限设置",showCancel:!1,success:()=>{e.wx$1.openSetting()}})}})},k=()=>{l.value&&w.value.reverseGeocoder({location:{latitude:l.value.latitude,longitude:l.value.longitude},get_poi:1,poi_options:"radius=150;page_size=8;policy=2;orderby=_distance",success:t=>{var i,s;if(((s=(i=t.result)==null?void 0:i.pois)==null?void 0:s.length)>0){const c=t.result.pois.sort((n,J)=>n._distance-J._distance).map(n=>({title:n.title,distance:n._distance,poi:n}));c[0].distance>200&&c.unshift({title:"当前位置",distance:0,poi:null}),u.value=c}else u.value=[{title:"当前位置",distance:0,poi:null}];p.value=!0},fail:t=>{e.index.__f__("error","at pages/release/release.vue:229","获取地点失败",t),u.value=[{title:"当前位置",distance:0,poi:null}],p.value=!0}})},b=()=>{if(!p.value)return e.index.showToast({title:"地点信息尚未加载完成",icon:"none"});l.value?e.index.navigateTo({url:`/pages/release/locationList?lat=${l.value.latitude}&lng=${l.value.longitude}`}):e.index.showToast({title:"位置信息未获取，请稍后再试",icon:"none"})},S=t=>{e.index.__f__("log","at pages/release/release.vue:255","[发布页] 添加新位置:",t.title),y.value.some(s=>s.poi&&t.poi&&s.poi.id?s.poi.id===t.poi.id:s.title.trim().toLowerCase()===t.title.trim().toLowerCase())?e.index.__f__("log","at pages/release/release.vue:272","位置已存在:",t.title):(e.index.__f__("log","at pages/release/release.vue:266","位置不存在，添加新位置"),u.value.unshift({title:t.title,poi:t.poi})),r.value=t.title},M=t=>{r.value=t},q=e.ref({width:95,height:95,border:{color:"#eee",width:"1px",style:"solid",radius:"13rpx"}}),C=async()=>{try{const t=await x.collection("opendb-news-categories").orderBy("sort","asc").get();t.result&&t.result.data?m.value=t.result.data:(e.index.__f__("error","at pages/release/release.vue:305","标签数据获取失败",t),e.index.showToast({title:"标签加载失败",icon:"none"}))}catch(t){e.index.__f__("error","at pages/release/release.vue:312","获取标签错误:",t),e.index.showToast({title:"标签加载失败",icon:"none"})}},A=t=>{const s=o.value.indexOf(t);if(s===-1){if(o.value.length>=3)return e.index.showToast({title:"最多选择3个标签",icon:"none"});o.value.push(t)}else o.value.splice(s,1)},V=()=>{e.index.switchTab({url:"/pages/home/home"})};function W(t){e.index.__f__("log","at pages/release/release.vue:347","选择文件：",t),e.index.__f__("log","at pages/release/release.vue:348",d)}function X(t){e.index.__f__("log","at pages/release/release.vue:352","上传进度：",t)}function j(t){e.index.__f__("log","at pages/release/release.vue:356","上传成功",t)}function G(t){e.index.__f__("log","at pages/release/release.vue:360","上传失败：",t)}const I=async()=>{if(!f.value.trim())return e.index.showToast({title:"请输入标题",icon:"none"});if(!g.value.trim())return e.index.showToast({title:"请输入正文内容",icon:"none"});if(o.value.length===0)return e.index.showToast({title:"请选择至少一个标签",icon:"none"});e.index.showLoading({title:"发布中...",mask:!0});try{let t=[],i=[];if(d.value.length>0&&(i=await h.value.upload(),e.index.__f__("log","at pages/release/release.vue:390","upload result:",JSON.stringify(i,null,2)),e.index.__f__("log","at pages/release/release.vue:391","上传结果:",i),t=i.map(a=>a.fileID||a.url).filter(a=>typeof a=="string"&&a.startsWith("cloud://")),e.index.__f__("log","at pages/release/release.vue:396","上传的 fileID:",t)),t.length!==i.length)throw new Error("有图片上传失败或 fileID 非法");const s={header:f.value,content:g.value,category_id:o.value,images:t};r.value&&(s.location={address:r.value}),await x.collection("posts").add(s),e.index.showToast({title:"发布成功",icon:"success"}),e.index.reLaunch({url:"/pages/release/release"}),setTimeout(()=>{e.index.switchTab({url:"/pages/Commity/Commity"})},1500)}catch(t){e.index.__f__("error","at pages/release/release.vue:442","发布失败:",t),e.index.showToast({title:"发布失败: "+(t.message||"请检查网络"),icon:"none",duration:3e3})}finally{e.index.hideLoading()}};return(t,i)=>({a:_._imports_0$3,b:e.o(V),c:e.sr(h,"4c7048b1-0",{k:"files"}),d:e.o(W),e:e.o(X),f:e.o(j),g:e.o(G),h:e.o(s=>d.value=s),i:e.p({fileMediatype:"image",mode:"grid",limit:4,"image-styles":q.value,autoUpload:!1,modelValue:d.value}),j:f.value,k:e.o(s=>f.value=s.detail.value),l:-1,m:g.value,n:e.o(s=>g.value=s.detail.value),o:_._imports_1$2,p:e.f(m.value,(s,a,c)=>({a:e.t(s.name),b:o.value.includes(s._id)?1:"",c:e.o(n=>A(s._id),s._id),d:s._id})),q:_._imports_0$4,r:_._imports_3$2,s:e.f(y.value,(s,a,c)=>({a:e.t(s.title),b:r.value===s.title?1:"",c:e.o(n=>M(s.title),a),d:a})),t:e.o(b),v:_._imports_4$2,w:e.o(I)})}};wx.createPage(P);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/release/release.js.map
