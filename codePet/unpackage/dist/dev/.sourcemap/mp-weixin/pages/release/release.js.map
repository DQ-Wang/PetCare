{"version":3,"file":"release.js","sources":["pages/release/release.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcmVsZWFzZS9yZWxlYXNlLnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"pet-container\">\r\n    <image class=\"back-arrow\" src=\"/static/汪汪喵切图/发布/左箭头.png\" @click=\"goBack\"></image>\r\n\r\n    <view class=\"edit-area\">\r\n      <view class=\"pic-upload\">\r\n        <uni-file-picker v-model=\"imageValue\" fileMediatype=\"image\" mode=\"grid\" :limit=\"4\" :image-styles=\"imageStyles\"\r\n          :autoUpload=\"false\" ref=\"files\" @select=\"select\" @progress=\"progress\" @success=\"success\" @fail=\"fail\" />\r\n      </view>\r\n\r\n      <view class=\"text-upload\">\r\n        <input v-model=\"title\" placeholder=\"添加标题\" maxlength=\"10\" placeholder-class=\"title-placeholder\"\r\n          class=\"title-area\" />\r\n\r\n        <textarea v-model=\"content\" placeholder=\"添加正文\" placeholder-class=\"main-placeholder\" class=\"main-area\"\r\n          auto-height :maxlength=\"-1\" />\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"tag-container\">\r\n      <view class=\"tag-title\">\r\n        <image src=\"/static/汪汪喵切图/发布/标签.png\" style=\"width: 28rpx; height: 28rpx;\"></image>\r\n        <text>标签</text>\r\n      </view>\r\n\r\n      <view class=\"tags-wrap\">\r\n        <view v-for=\"item in tagList\" :key=\"item._id\">\r\n          <view class=\"tag\" :class=\"{'tag-selected': selectedTags.includes(item._id)}\"\r\n            @click=\"handleTagSelect(item._id)\">\r\n            {{item.name}}\r\n          </view>\r\n        </view>\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"divider-line\"></view>\r\n\r\n    <view class=\"location-container\">\r\n      <view class=\"location-title\">\r\n        <image src=\"/static/汪汪喵切图/发布/位置.png\" style=\"width: 28rpx; height: 28rpx;\"></image>\r\n        <text>位置</text>\r\n        <view class=\"spacer\"></view>\r\n        <image class=\"right-arrow\" src=\"/static/汪汪喵切图/发布/右箭头.png\" style=\"width: 11.22rpx; height: 19.36rpx;\"></image>\r\n      </view>\r\n\r\n      <scroll-view class=\"locations-wrap\" scroll-x enable-flex>\r\n        <view v-for=\"(loc,index) in locations\" :key=\"index\">\r\n          <view class=\"location\" :class=\"{'location-selected': selectedLocation === loc}\"\r\n            @click=\"handleLocationSelect(loc)\">\r\n            {{loc}}\r\n          </view>\r\n        </view>\r\n      </scroll-view>\r\n    </view>\r\n\r\n    <button class=\"release-button\" @click=\"handleRelease\">\r\n      <image src=\"/static/汪汪喵切图/发布/发布.png\" style=\"width: 47rpx; height: 47rpx;\"></image>\r\n      <view class=\"release-text\">\r\n        发布笔记\r\n      </view>\r\n    </button>\r\n  </view>\r\n\r\n</template>\r\n\r\n<script setup>\r\n  import {\r\n    ref,\r\n    onMounted\r\n  } from 'vue'\r\n\r\n  const db = uniCloud.database();\r\n\r\n  //文件上传相关\r\n  const files = ref(null)\r\n  const imageValue = ref([])\r\n\r\n  //表单数据\r\n  const title = ref('')\r\n  const content = ref('')\r\n  const selectedTags = ref([])\r\n  const selectedLocation = ref('')\r\n\r\n  //标签数据（从数据库获取）\r\n  const tagList = ref([])\r\n\r\n  //位置数据\r\n  const locations = ref([\r\n    '厦门大学翔安校区',\r\n    '香山郊野公园',\r\n    '厦门大学翔安校区丰庭食堂',\r\n    '厦门大学信息学院',\r\n    '查看更多'\r\n  ])\r\n\r\n  //图片上传的配置\r\n  const imageStyles = ref({\r\n    width: 95,\r\n    height: 95,\r\n    border: {\r\n      color: \"#eee\",\r\n      width: \"1px\",\r\n      style: \"solid\",\r\n      radius: \"13rpx\"\r\n    }\r\n  })\r\n\r\n  //获取标签数据\r\n  const getTags = async () => {\r\n    try {\r\n      const res = await db.collection('opendb-news-categories')\r\n        .orderBy('sort', 'asc')\r\n        .get()\r\n\r\n      if (res.result && res.result.data) {\r\n        tagList.value = res.result.data\r\n      } else {\r\n        console.error('标签数据获取失败', res)\r\n        uni.showToast({\r\n          title: '标签加载失败',\r\n          icon: 'none'\r\n        })\r\n      }\r\n    } catch (e) {\r\n      console.error('获取标签错误:', e)\r\n      uni.showToast({\r\n        title: '标签加载失败',\r\n        icon: 'none'\r\n      })\r\n    }\r\n  }\r\n\r\n  //处理标签选择\r\n  const handleTagSelect = (tagId) => {\r\n    const MAX_TAGS = 3;\r\n    const index = selectedTags.value.indexOf(tagId);\r\n\r\n    if (index === -1) {\r\n      if (selectedTags.value.length >= MAX_TAGS) {\r\n        return uni.showToast({\r\n          title: `最多选择${MAX_TAGS}个标签`,\r\n          icon: 'none'\r\n        });\r\n      }\r\n      selectedTags.value.push(tagId);\r\n    } else {\r\n      selectedTags.value.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  //处理位置选择\r\n  const handleLocationSelect = (location) => {\r\n    if (location === '查看更多') {\r\n      // 实际项目中接入位置API\r\n      uni.showToast({\r\n        title: '位置功能待实现',\r\n        icon: 'none'\r\n      });\r\n    } else {\r\n      selectedLocation.value = location;\r\n    }\r\n  }\r\n\r\n  //返回上一页\r\n  const goBack = () => {\r\n    uni.switchTab({\r\n      url: '/pages/home/home'\r\n    })\r\n  }\r\n\r\n  // 文件上传相关事件\r\n  function select(e) {\r\n    console.log('选择文件：', e)\r\n    console.log(imageValue)\r\n  }\r\n\r\n  function progress(e) {\r\n    console.log('上传进度：', e)\r\n  }\r\n\r\n  function success(e) {\r\n    console.log('上传成功', e)\r\n  }\r\n\r\n  function fail(e) {\r\n    console.log('上传失败：', e)\r\n  }\r\n\r\n  //发布功能\r\n  const handleRelease = async () => {\r\n    //表单验证\r\n    if (!title.value.trim()) return uni.showToast({\r\n      title: '请输入标题',\r\n      icon: 'none'\r\n    })\r\n    if (!content.value.trim()) return uni.showToast({\r\n      title: '请输入正文内容',\r\n      icon: 'none'\r\n    })\r\n    if (selectedTags.value.length === 0) return uni.showToast({\r\n      title: '请选择至少一个标签',\r\n      icon: 'none'\r\n    })\r\n\r\n    uni.showLoading({\r\n      title: '发布中...',\r\n      mask: true\r\n    })\r\n\r\n    try {\r\n      let imageFileIDs = [] //图片文件ID\r\n      let imageUrls = [] //最终可访问的图片URL\r\n\r\n      //处理图片上传\r\n      if (imageValue.value.length > 0) {\r\n        try {\r\n          //执行上传并等待返回结果\r\n          const uploadResult = await files.value.upload()\r\n          console.log('上传结果:', uploadResult)\r\n\r\n          //提取所有上传成功文件的fileID\r\n          const fileIDs = uploadResult.map(item => item.fileID || item.url)\r\n          console.log('提取的fileID:', fileIDs)\r\n\r\n          //将fileID转换为可访问的URL\r\n          const tempURLsRes = await uniCloud.getTempFileURL({\r\n            fileList: fileIDs\r\n          })\r\n          console.log('临时URL转换结果:', tempURLsRes)\r\n\r\n          //提取成功的URL链接\r\n          imageUrls = tempURLsRes.fileList.map(item => item.tempFileURL)\r\n          console.log('转换后的图片URL:', imageUrls)\r\n        } catch (uploadError) {\r\n          console.error('文件上传失败:', uploadError)\r\n          throw new Error('图片上传失败，请重试')\r\n        }\r\n      }\r\n\r\n      //构造提交数据\r\n      const postData = {\r\n        header: title.value,\r\n        content: content.value,\r\n        category_id: selectedTags.value,\r\n        images: imageUrls,\r\n      }\r\n\r\n      //添加位置信息\r\n      if (selectedLocation.value) {\r\n        postData.location = {\r\n          name: selectedLocation.value,\r\n          latitude: 0,\r\n          longitude: 0\r\n        }\r\n      }\r\n\r\n      //提交到数据库\r\n      await db.collection('posts').add(postData)\r\n\r\n      uni.showToast({\r\n        title: '发布成功',\r\n        icon: 'success'\r\n      })\r\n      setTimeout(() => {\r\n        uni.switchTab({\r\n          url: '/pages/home/home'\r\n        })\r\n      }, 1500)\r\n\r\n    } catch (err) {\r\n      console.error('发布失败:', err)\r\n      uni.showToast({\r\n        title: '发布失败: ' + (err.message || '请检查网络'),\r\n        icon: 'none',\r\n        duration: 3000\r\n      })\r\n    } finally {\r\n      uni.hideLoading()\r\n    }\r\n  }\r\n\r\n  //页面加载时获取标签\r\n  onMounted(() => {\r\n    getTags()\r\n  })\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n  @import '@/petcareui/pet-global.css';\r\n\r\n  .pet-container {\r\n    background-color: rgba(246, 247, 251, 1);\r\n  }\r\n\r\n  .back-arrow {\r\n    width: 16rpx;\r\n    height: 28rpx;\r\n\r\n    margin: 105rpx 0 0 36rpx;\r\n  }\r\n\r\n  .pic-upload {\r\n    padding: 0 31rpx;\r\n    margin-top: 51rpx;\r\n\r\n    /* 自定义uni-file-picker样式 */\r\n    ::v-deep .uni-file-picker {\r\n      .uni-file-picker__header {\r\n        display: none;\r\n        /* 隐藏标题 */\r\n      }\r\n\r\n      .uni-file-picker__container {\r\n        margin-top: 0;\r\n      }\r\n\r\n      .file-picker__box-content {\r\n        background-color: #e5e5e5;\r\n      }\r\n\r\n      .icon-add {\r\n        width: 60rpx;\r\n        background-color: #a6a6a6 !important;\r\n        border-radius: 13rpx;\r\n      }\r\n    }\r\n  }\r\n\r\n  .text-upload {\r\n    padding: 0 45rpx;\r\n    margin-top: 41rpx;\r\n\r\n    .title-area {\r\n      height: 55rpx;\r\n    }\r\n\r\n    .title-placeholder {\r\n      text-align: left;\r\n      vertical-align: middle;\r\n      font-size: 37.5rpx;\r\n      font-weight: 500;\r\n      letter-spacing: 3.13rpx;\r\n      line-height: 54.3rpx;\r\n      color: $p-text-secondary;\r\n    }\r\n\r\n    .main-area {\r\n      width: 100%;\r\n      min-height: 200rpx;\r\n      margin-top: 27rpx;\r\n    }\r\n\r\n    .main-placeholder {\r\n      font-size: 25rpx;\r\n      font-weight: 400;\r\n      letter-spacing: 1.56rpx;\r\n      line-height: 36.2rpx;\r\n      color: $p-text-secondary;\r\n      text-align: left;\r\n      vertical-align: middle;\r\n    }\r\n  }\r\n\r\n  .tag-container,\r\n  .location-container {\r\n    padding: 0 38rpx;\r\n\r\n    .tag-title,\r\n    .location-title {\r\n      height: 45rpx;\r\n      display: flex;\r\n      align-items: center;\r\n      padding-right: 17rpx;\r\n\r\n      text {\r\n        margin-left: 16rpx;\r\n        font-size: 18.75rpx;\r\n        font-weight: 400;\r\n        letter-spacing: 1.56rpx;\r\n        line-height: 27.16rpx;\r\n        color: $p-text-secondary;\r\n      }\r\n    }\r\n\r\n    .location-title {\r\n      position: relative;\r\n\r\n      .spacer {\r\n        flex: 1;\r\n      }\r\n\r\n      .right-arrow {\r\n        margin-left: auto;\r\n      }\r\n    }\r\n\r\n    .tags-wrap,\r\n    .locations-wrap {\r\n      display: flex;\r\n      flex-wrap: wrap;\r\n      margin-top: 36rpx;\r\n\r\n      .tag,\r\n      .location {\r\n        margin: 0 15.5rpx 22rpx 15.5rpx;\r\n        opacity: 0.5;\r\n        border-radius: 40rpx;\r\n        background: rgba(204, 204, 204, 1);\r\n        padding: 9rpx 23rpx;\r\n        font-size: 18.75rpx;\r\n        font-weight: 400;\r\n        letter-spacing: 0rpx;\r\n        color: rgba(107, 107, 107, 1.0);\r\n        transition: all 0.3s ease;\r\n\r\n        &.tag-selected,\r\n        &.location-selected {\r\n          opacity: 1;\r\n          background: $p-primary-color;\r\n          color: $p-text-color;\r\n        }\r\n      }\r\n\r\n      .location {\r\n        padding: 9rpx 28rpx;\r\n      }\r\n    }\r\n\r\n    .locations-wrap {\r\n      display: flex;\r\n      flex-wrap: nowrap;\r\n      overflow-x: auto;\r\n      white-space: nowrap;\r\n    }\r\n  }\r\n\r\n  .divider-line {\r\n    margin: 23rpx 28rpx 45rpx 28rpx;\r\n    height: 1rpx;\r\n    background-color: rgba(166, 166, 166, 1);\r\n  }\r\n\r\n  .release-button {\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n    width: 378.13rpx;\r\n    height: 81.25rpx;\r\n    border-radius: 16.5rpx;\r\n    background: $p-primary-color;\r\n    margin-top: 190rpx;\r\n\r\n    .release-text {\r\n      margin-left: 16rpx;\r\n      font-size: 37.5rpx;\r\n      font-weight: 400;\r\n      letter-spacing: 1.56rpx;\r\n      line-height: 54.3rpx;\r\n      color: $p-text-color;\r\n    }\r\n  }\r\n</style>","import MiniProgramPage from 'D:/Hbuilder X test/PetCare/codePet/pages/release/release.vue'\nwx.createPage(MiniProgramPage)"],"names":["uniCloud","ref","uni","onMounted","MiniProgramPage"],"mappings":"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"}