{"version":3,"file":"choose-and-upload-file.js","sources":["uni_modules/uni-file-picker/components/uni-file-picker/choose-and-upload-file.js"],"sourcesContent":["'use strict';\r\n\r\nconst ERR_MSG_OK = 'chooseAndUploadFile:ok';\r\nconst ERR_MSG_FAIL = 'chooseAndUploadFile:fail';\r\n\r\nfunction chooseImage(opts) {\r\n\tconst {\r\n\t\tcount,\r\n\t\tsizeType = ['original', 'compressed'],\r\n\t\tsourceType,\r\n\t\textension\r\n\t} = opts\r\n\treturn new Promise((resolve, reject) => {\r\n\t\t// 微信由于旧接口不再维护，针对微信小程序平台改用chooseMedia接口\r\n\t\t// #ifdef MP-WEIXIN\r\n\t\tuni.chooseMedia({\r\n\t\t\tcount,\r\n\t\t\tsizeType,\r\n\t\t\tsourceType,\r\n\t\t\tmediaType: ['image'],\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tres.tempFiles.forEach(item => {\r\n\t\t\t\t\titem.path = item.tempFilePath;\r\n\t\t\t\t})\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res, 'image'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseImage:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t})\r\n\t\t// #endif\r\n\t\t// #ifndef MP-WEIXIN\r\n\t\tuni.chooseImage({\r\n\t\t\tcount,\r\n\t\t\tsizeType,\r\n\t\t\tsourceType,\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res, 'image'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseImage:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t});\r\n\t\t// #endif\r\n\r\n\t});\r\n}\r\n\r\nfunction chooseVideo(opts) {\r\n\tconst {\r\n\t\tcount,\r\n\t\tcamera,\r\n\t\tcompressed,\r\n\t\tmaxDuration,\r\n\t\tsourceType,\r\n\t\textension\r\n\t} = opts;\r\n\treturn new Promise((resolve, reject) => {\r\n\t\t// 微信由于旧接口不再维护，针对微信小程序平台改用chooseMedia接口\r\n\t\t// #ifdef MP-WEIXIN\r\n\t\tuni.chooseMedia({\r\n\t\t\tcount,\r\n\t\t\tcompressed,\r\n\t\t\tmaxDuration,\r\n\t\t\tsourceType,\r\n\t\t\textension,\r\n\t\t\tmediaType: ['video'],\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tconst {\r\n\t\t\t\t\ttempFiles,\r\n\t\t\t\t} = res;\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes({\r\n\t\t\t\t\terrMsg: 'chooseVideo:ok',\r\n\t\t\t\t\ttempFiles: tempFiles.map(item => {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tname: item.name || '',\r\n\t\t\t\t\t\t\tpath: item.tempFilePath,\r\n\t\t\t\t\t\t\tthumbTempFilePath: item.thumbTempFilePath,\r\n\t\t\t\t\t\t\tsize:item.size,\r\n\t\t\t\t\t\t\ttype: (res.tempFile && res.tempFile.type) || '',\r\n\t\t\t\t\t\t\twidth:item.width,\r\n\t\t\t\t\t\t\theight:item.height,\r\n\t\t\t\t\t\t\tduration:item.duration,\r\n\t\t\t\t\t\t\tfileType: 'video',\r\n\t\t\t\t\t\t\tcloudPath: '',\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}),\r\n\t\t\t\t}, 'video'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseVideo:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t})\r\n\t\t// #endif\r\n\t\t// #ifndef MP-WEIXIN\r\n\t\tuni.chooseVideo({\r\n\t\t\tcamera,\r\n\t\t\tcompressed,\r\n\t\t\tmaxDuration,\r\n\t\t\tsourceType,\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tconst {\r\n\t\t\t\t\ttempFilePath,\r\n\t\t\t\t\tduration,\r\n\t\t\t\t\tsize,\r\n\t\t\t\t\theight,\r\n\t\t\t\t\twidth\r\n\t\t\t\t} = res;\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes({\r\n\t\t\t\t\terrMsg: 'chooseVideo:ok',\r\n\t\t\t\t\ttempFilePaths: [tempFilePath],\r\n\t\t\t\t\ttempFiles: [{\r\n\t\t\t\t\t\tname: (res.tempFile && res.tempFile.name) || '',\r\n\t\t\t\t\t\tpath: tempFilePath,\r\n\t\t\t\t\t\tsize,\r\n\t\t\t\t\t\ttype: (res.tempFile && res.tempFile.type) || '',\r\n\t\t\t\t\t\twidth,\r\n\t\t\t\t\t\theight,\r\n\t\t\t\t\t\tduration,\r\n\t\t\t\t\t\tfileType: 'video',\r\n\t\t\t\t\t\tcloudPath: '',\r\n\t\t\t\t\t}, ],\r\n\t\t\t\t}, 'video'));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseVideo:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t});\r\n\t\t// #endif\r\n\t});\r\n}\r\n\r\nfunction chooseAll(opts) {\r\n\tconst {\r\n\t\tcount,\r\n\t\textension\r\n\t} = opts;\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tlet chooseFile = uni.chooseFile;\r\n\t\tif (typeof wx !== 'undefined' &&\r\n\t\t\ttypeof wx.chooseMessageFile === 'function') {\r\n\t\t\tchooseFile = wx.chooseMessageFile;\r\n\t\t}\r\n\t\tif (typeof chooseFile !== 'function') {\r\n\t\t\treturn reject({\r\n\t\t\t\terrMsg: ERR_MSG_FAIL + ' 请指定 type 类型，该平台仅支持选择 image 或 video。',\r\n\t\t\t});\r\n\t\t}\r\n\t\tchooseFile({\r\n\t\t\ttype: 'all',\r\n\t\t\tcount,\r\n\t\t\textension,\r\n\t\t\tsuccess(res) {\r\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res));\r\n\t\t\t},\r\n\t\t\tfail(res) {\r\n\t\t\t\treject({\r\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseFile:fail', ERR_MSG_FAIL),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction normalizeChooseAndUploadFileRes(res, fileType) {\r\n\tres.tempFiles.forEach((item, index) => {\r\n\t\tif (!item.name) {\r\n\t\t\titem.name = item.path.substring(item.path.lastIndexOf('/') + 1);\r\n\t\t}\r\n\t\tif (fileType) {\r\n\t\t\titem.fileType = fileType;\r\n\t\t}\r\n\t\titem.cloudPath =\r\n\t\t\tDate.now() + '_' + index + item.name.substring(item.name.lastIndexOf('.'));\r\n\t});\r\n\tif (!res.tempFilePaths) {\r\n\t\tres.tempFilePaths = res.tempFiles.map((file) => file.path);\r\n\t}\r\n\treturn res;\r\n}\r\n\r\nfunction uploadCloudFiles(files, max = 5, onUploadProgress) {\r\n\tfiles = JSON.parse(JSON.stringify(files))\r\n\tconst len = files.length\r\n\tlet count = 0\r\n\tlet self = this\r\n\treturn new Promise(resolve => {\r\n\t\twhile (count < max) {\r\n\t\t\tnext()\r\n\t\t}\r\n\r\n\t\tfunction next() {\r\n\t\t\tlet cur = count++\r\n\t\t\tif (cur >= len) {\r\n\t\t\t\t!files.find(item => !item.url && !item.errMsg) && resolve(files)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tconst fileItem = files[cur]\r\n\t\t\tconst index = self.files.findIndex(v => v.uuid === fileItem.uuid)\r\n\t\t\tfileItem.url = ''\r\n\t\t\tdelete fileItem.errMsg\r\n\r\n\t\t\tuniCloud\r\n\t\t\t\t.uploadFile({\r\n\t\t\t\t\tfilePath: fileItem.path,\r\n\t\t\t\t\tcloudPath: fileItem.cloudPath,\r\n\t\t\t\t\tfileType: fileItem.fileType,\r\n\t\t\t\t\tonUploadProgress: res => {\r\n\t\t\t\t\t\tres.index = index\r\n\t\t\t\t\t\tonUploadProgress && onUploadProgress(res)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.then(res => {\r\n\t\t\t\t\tfileItem.url = res.fileID\r\n\t\t\t\t\tfileItem.index = index\r\n\t\t\t\t\tif (cur < len) {\r\n\t\t\t\t\t\tnext()\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.catch(res => {\r\n\t\t\t\t\tfileItem.errMsg = res.errMsg || res.message\r\n\t\t\t\t\tfileItem.index = index\r\n\t\t\t\t\tif (cur < len) {\r\n\t\t\t\t\t\tnext()\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t}\r\n\t})\r\n}\r\n\r\n\r\n\r\n\r\n\r\nfunction uploadFiles(choosePromise, {\r\n\tonChooseFile,\r\n\tonUploadProgress\r\n}) {\r\n\treturn choosePromise\r\n\t\t.then((res) => {\r\n\t\t\tif (onChooseFile) {\r\n\t\t\t\tconst customChooseRes = onChooseFile(res);\r\n\t\t\t\tif (typeof customChooseRes !== 'undefined') {\r\n\t\t\t\t\treturn Promise.resolve(customChooseRes).then((chooseRes) => typeof chooseRes === 'undefined' ?\r\n\t\t\t\t\t\tres : chooseRes);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn res;\r\n\t\t})\r\n\t\t.then((res) => {\r\n\t\t\tif (res === false) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\terrMsg: ERR_MSG_OK,\r\n\t\t\t\t\ttempFilePaths: [],\r\n\t\t\t\t\ttempFiles: [],\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\treturn res\r\n\t\t})\r\n}\r\n\r\nfunction chooseAndUploadFile(opts = {\r\n\ttype: 'all'\r\n}) {\r\n\tif (opts.type === 'image') {\r\n\t\treturn uploadFiles(chooseImage(opts), opts);\r\n\t} else if (opts.type === 'video') {\r\n\t\treturn uploadFiles(chooseVideo(opts), opts);\r\n\t}\r\n\treturn uploadFiles(chooseAll(opts), opts);\r\n}\r\n\r\nexport {\r\n\tchooseAndUploadFile,\r\n\tuploadCloudFiles\r\n};\r\n"],"names":["ERR_MSG_OK","ERR_MSG_FAIL","chooseImage","opts","count","sizeType","sourceType","extension","resolve","reject","uni","res","item","normalizeChooseAndUploadFileRes","chooseVideo","camera","compressed","maxDuration","tempFiles","chooseAll","chooseFile","wx","fileType","index","file","uploadCloudFiles","files","max","onUploadProgress","len","self","next","cur","fileItem","v","uniCloud","uploadFiles","choosePromise","onChooseFile","customChooseRes","chooseRes","chooseAndUploadFile"],"mappings":"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"}